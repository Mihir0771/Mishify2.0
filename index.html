<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Private Mix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #FFF1F2; }
        h1, h2, h3 { font-family: 'Playfair Display', serif; }
        .spinner { border-top-color: #f43f5e; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .reaction-pop { animation: pop 0.7s ease-out forwards; }
        @keyframes pop {
            0% { transform: scale(0.5) translateY(0); opacity: 0; }
            50% { transform: scale(1.3); opacity: 1; }
            100% { transform: scale(1) translateY(-60px); opacity: 0; }
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #fee2e2; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #fb7185; border-radius: 3px;}
        .heart-btn.loved path { fill: #f43f5e; stroke: #f43f5e; }
        .heart-btn path { transition: all 0.2s ease-in-out; }
        #modal-overlay.hidden { display: none; }
    </style>
</head>
<body class="antialiased text-rose-800">

    <div id="main-container" class="min-h-screen flex items-center justify-center p-4">

        <div id="login-view" class="w-full max-w-md text-center">
            <div class="bg-white/70 backdrop-blur-sm rounded-3xl shadow-2xl shadow-rose-200 p-8 md:p-12">
                <div class="inline-block p-3 bg-rose-100 rounded-full mb-4">
                    <svg class="w-8 h-8 text-rose-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                </div>
                <h1 class="text-4xl md:text-5xl font-bold text-rose-900">Our Private Mix</h1>
                <p class="text-rose-700 mt-2 mb-8">Just for you and me. In perfect harmony.</p>
                <button id="login-button" class="w-full bg-rose-500 text-white font-bold py-3 px-4 rounded-xl hover:bg-rose-600 transition-colors duration-300 shadow-lg shadow-rose-500/30">
                    Connect with Spotify
                </button>
            </div>
        </div>

        <div id="app-view" class="hidden w-full max-w-5xl h-[85vh] md:h-[80vh] bg-white/70 backdrop-blur-sm rounded-3xl shadow-2xl shadow-rose-200 p-6 grid grid-cols-1 md:grid-cols-3 gap-6">

            <div class="md:col-span-1 flex flex-col items-center justify-center text-center p-6 bg-rose-100/50 rounded-2xl space-y-4">
                <div id="partner-status" class="w-full flex justify-around items-center">
                    </div>
                <div class="relative">
                    <img id="album-art" src="https://placehold.co/600x600/fecdd3/9f1239?text=Our+Mix" class="w-48 h-48 rounded-2xl shadow-2xl shadow-rose-300" alt="Album Art">
                    <div id="reaction-container" class="absolute inset-0 flex items-center justify-center text-5xl pointer-events-none"></div>
                </div>
                <div>
                    <h2 id="track-name" class="text-2xl font-bold text-rose-900 truncate">Welcome!</h2>
                    <p id="artist-name" class="text-rose-600">Play a song on Spotify to begin</p>
                </div>
                <div class="flex justify-center items-center space-x-4">
                        <button id="memory-btn" class="heart-btn text-rose-400 hover:text-rose-500 transition" title="Make this one of our songs">
                            <svg class="w-8 h-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                        </button>
                        <button class="reaction-btn text-2xl transform hover:scale-125 transition" data-emoji="üòç">üòç</button>
                        <button class="reaction-btn text-2xl transform hover:scale-125 transition" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</button>
                        <button class="reaction-btn text-2xl transform hover:scale-125 transition" data-emoji="‚ú®">‚ú®</button>
                </div>
                 <p class="text-xs text-rose-400 mt-1 font-mono">Share this page with your partner!</p>
            </div>

            <div class="md:col-span-2 flex flex-col bg-white/50 rounded-2xl p-4 overflow-hidden">
                <div class="flex border-b border-rose-200 mb-4">
                    <button class="tab-btn active p-3 font-semibold text-rose-600 border-b-2 border-rose-500" data-tab="queue">Queue</button>
                    <button class="tab-btn p-3 font-semibold text-rose-400" data-tab="chat">Chat</button>
                    <button class="tab-btn p-3 font-semibold text-rose-400" data-tab="memories">Memories</button>
                </div>
                <div class="flex-grow overflow-hidden">
                    <div id="queue-tab" class="tab-content h-full flex flex-col">
                        <form id="search-form" class="flex items-center mb-4">
                            <input type="text" id="search-input" class="flex-grow p-2 border border-rose-200 rounded-l-lg focus:ring-rose-500 focus:border-rose-500" placeholder="Search for a song...">
                            <button id="search-button" type="submit" class="bg-rose-500 text-white p-2 rounded-r-lg hover:bg-rose-600 w-20 text-center">Search</button>
                        </form>
                        <div id="search-results" class="custom-scrollbar overflow-y-auto space-y-2 mb-2"></div>
                        <h3 class="font-bold text-lg text-rose-800 border-t border-rose-200 pt-2 mt-2">Up Next</h3>
                        <div id="queue-list" class="flex-grow custom-scrollbar overflow-y-auto space-y-2"></div>
                    </div>
                    <div id="chat-tab" class="tab-content hidden h-full flex flex-col">
                        <div id="chat-messages" class="flex-grow custom-scrollbar overflow-y-auto mb-4 space-y-4 p-2"></div>
                        <form id="chat-form" class="flex">
                            <input id="chat-input" type="text" class="flex-grow p-2 border border-rose-200 rounded-l-lg focus:ring-rose-500 focus:border-rose-500" placeholder="Say something..." required>
                            <button type="submit" class="bg-rose-500 text-white p-2 rounded-r-lg hover:bg-rose-600">Send</button>
                        </form>
                    </div>
                    <div id="memories-tab" class="tab-content hidden h-full flex flex-col">
                         <div id="memories-list" class="flex-grow custom-scrollbar overflow-y-auto space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="loading-view" class="hidden text-center">
            <div class="spinner w-12 h-12 rounded-full border-4 border-rose-200"></div>
            <p class="mt-4 text-rose-600 font-semibold">Preparing Your Room...</p>
        </div>
    </div>

    <div id="modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 max-w-sm text-center">
            <h3 id="modal-title" class="text-xl font-bold text-rose-900 mb-2"></h3>
            <p id="modal-message" class="text-rose-700 mb-6"></p>
            <button id="modal-button" class="bg-rose-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-rose-600 transition">Got it</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion, arrayRemove, collection, addDoc, query, orderBy, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. CONFIGURATION ---
        
        // FIX: Paste your unique Spotify Client ID here.
        const SPOTIFY_CLIENT_ID = "90bba7474b9a454e9a667474cfdcc044"; 
        
        // FIX: Paste your Firebase config object here.
        const firebaseConfig = {
        apiKey: "AIzaSyChZQ1R64iJy-Xlbep9PCin4F60xe4vP8A",
        authDomain: "mishify-2.firebaseapp.com",
        projectId: "mishify-2",
        storageBucket: "mishify-2.firebasestorage.app",
        messagingSenderId: "95384938223",
        appId: "1:95384938223:web:161b1c0045296786d4dd1a",
        measurementId: "G-HB0QW42NJR"
        };
        
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        const appId = 'our-private-mix-room-1'; // A unique ID for your shared room

        // --- 2. GLOBAL STATE & UI ---
        let db, auth, userId, accessToken, userProfile;
        let lastTrackUri = null;
        let currentNowPlaying = {};

        const ui = {
            loginView: document.getElementById('login-view'),
            appView: document.getElementById('app-view'),
            loadingView: document.getElementById('loading-view'),
            loginButton: document.getElementById('login-button'),
            albumArt: document.getElementById('album-art'),
            trackName: document.getElementById('track-name'),
            artistName: document.getElementById('artist-name'),
            partnerStatus: document.getElementById('partner-status'),
            searchForm: document.getElementById('search-form'),
            searchInput: document.getElementById('search-input'),
            searchButton: document.getElementById('search-button'),
            searchResults: document.getElementById('search-results'),
            queueList: document.getElementById('queue-list'),
            chatMessages: document.getElementById('chat-messages'),
            chatForm: document.getElementById('chat-form'),
            chatInput: document.getElementById('chat-input'),
            memoriesList: document.getElementById('memories-list'),
            reactionContainer: document.getElementById('reaction-container'),
            memoryBtn: document.getElementById('memory-btn'),
            modalOverlay: document.getElementById('modal-overlay'),
            modalTitle: document.getElementById('modal-title'),
            modalMessage: document.getElementById('modal-message'),
            modalButton: document.getElementById('modal-button'),
        };
        
        // --- 3. UTILITY FUNCTIONS ---
        const showModal = (title, message, buttonText = "Got it", onButtonClick = () => {}) => {
            ui.modalTitle.textContent = title;
            ui.modalMessage.textContent = message;
            ui.modalButton.textContent = buttonText;
            ui.modalOverlay.classList.remove('hidden');
            ui.modalButton.onclick = () => {
                ui.modalOverlay.classList.add('hidden');
                onButtonClick();
            };
        };

        // --- 4. INITIALIZATION ---
        window.onload = () => {
            if (SPOTIFY_CLIENT_ID === "YOUR_SPOTIFY_CLIENT_ID") {
                showModal("Configuration Needed", "The Spotify Client ID is missing. Please follow the setup instructions to add it to the code.", "Okay");
                ui.loginButton.disabled = true;
                ui.loginButton.textContent = "Configuration Missing";
                return;
            }
             if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                showModal("Configuration Needed", "The Firebase configuration is missing. Please add your project's config details to the code.", "Okay");
                ui.loginButton.disabled = true;
                ui.loginButton.textContent = "Configuration Missing";
                return;
            }
            initializeAppAndAuth();
            handleRedirect();
        };

        const initializeAppAndAuth = () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, user => { if (user) userId = user.uid; });
                signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
            } catch (error) { 
                console.error("Firebase init failed:", error);
                showModal("Firebase Error", "Could not connect to the database. Please check your Firebase configuration.");
            }
        };

        // --- 5. SPOTIFY AUTH & API ---
        ui.loginButton.addEventListener('click', () => {
            const scope = 'user-read-email user-read-private user-modify-playback-state user-read-playback-state user-read-currently-playing';
            // FIX: This URL was incorrect. It now points to the official Spotify accounts service.
            const authUrl = `https://accounts.spotify.com/authorize?client_id=${SPOTIFY_CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(scope)}`;
            window.location.href = authUrl;
        });

        const handleRedirect = () => {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const token = params.get('access_token');
            if (token) {
                accessToken = token;
                window.location.hash = '';
                ui.loginView.classList.add('hidden');
                ui.loadingView.classList.remove('hidden');
                initializeSession();
            }
        };

        const spotifyApi = async (endpoint, options = {}) => {
            if (!accessToken) return null;
            try {
                // FIX: This URL was incorrect. It now points to the official Spotify API v1.
                const res = await fetch(`https://api.spotify.com/v1${endpoint}`, {
                    ...options,
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json', ...options.headers },
                });
                if (res.status === 401) {
                    showModal("Session Expired", "Your Spotify session has expired. Please connect again to continue.", "Reconnect", () => window.location.reload());
                    accessToken = null; // Prevent further API calls
                    return null;
                }
                if (res.status === 204) return null; // No content, successful request
                if (!res.ok) throw new Error(`Spotify API error: ${res.statusText}`);
                return res.json();
            } catch (error) {
                console.error("Spotify API call failed", error);
                return null;
            }
        };

        // --- 6. CORE SESSION LOGIC ---
        const initializeSession = async () => {
            try {
                userProfile = await spotifyApi('/me');
                if (!userProfile) throw new Error("Could not fetch user profile.");

                await setupFirestoreListeners();
                await joinSession();
                ui.loadingView.classList.add('hidden');
                ui.appView.classList.remove('hidden');
                setInterval(pollCurrentlyPlaying, 5000);
                setInterval(sendHeartbeat, 15000);
            } catch (error) {
                console.error("Initialization failed:", error);
                showModal("Initialization Failed", "There was a problem setting up your room. Please try connecting again.", "Try Again", () => window.location.reload());
            }
        };

        const pollCurrentlyPlaying = async () => {
            const data = await spotifyApi('/me/player/currently-playing');
            if (data && data.item && data.item.uri !== lastTrackUri) {
                lastTrackUri = data.item.uri;
                const track = data.item;
                const nowPlayingData = {
                    trackUri: track.uri,
                    trackName: track.name,
                    artistName: track.artists.map(a => a.name).join(', '),
                    albumArtUrl: track.album.images[0].url,
                };
                await updateDoc(getSessionDocRef(), { nowPlaying: nowPlayingData });
            } else if (!data || !data.item) {
                lastTrackUri = null;
            }
        };
        
        // --- 7. FIRESTORE & PRESENCE ---
        const getSessionDocRef = () => doc(db, 'couple-rooms', appId);
        const getChatCollectionRef = () => collection(db, 'couple-rooms', appId, 'chat');

        const joinSession = async () => {
            const user = {
                id: userId,
                name: userProfile.display_name || 'Music Lover',
                imageUrl: userProfile.images?.[0]?.url || `https://placehold.co/60x60/fecdd3/9f1239?text=${userProfile.display_name?.[0] || 'A'}`,
                lastSeen: serverTimestamp()
            };
            const docRef = getSessionDocRef();
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                let users = docSnap.data().users.filter(u => u.id !== userId);
                users.push(user);
                if (users.length > 2) users = users.slice(-2); // Cap at 2 users
                await updateDoc(docRef, { users });
            } else {
                await setDoc(docRef, { users: [user], nowPlaying: {}, queue: [], memories: [], lastReaction: {} });
            }
        };

        const sendHeartbeat = async () => {
            const docRef = getSessionDocRef();
            const docSnap = await getDoc(docRef);
            if (docSnap.exists() && docSnap.data().users.some(u => u.id === userId)) {
                const users = docSnap.data().users.map(u => u.id === userId ? { ...u, lastSeen: serverTimestamp() } : u);
                await updateDoc(docRef, { users });
            }
        };

        const setupFirestoreListeners = () => {
            onSnapshot(getSessionDocRef(), (snapshot) => {
                if (!snapshot.exists()) return;
                const data = snapshot.data();
                updateNowPlayingUI(data.nowPlaying, data.memories);
                updateQueueUI(data.queue);
                updateMemoriesUI(data.memories);
                updatePartnerStatusUI(data.users);
                if (data.lastReaction && data.lastReaction.ts?.toMillis() !== window.lastReactionTimestamp) {
                    window.lastReactionTimestamp = data.lastReaction.ts?.toMillis();
                    showReaction(data.lastReaction.emoji);
                }
            });

            onSnapshot(query(getChatCollectionRef(), orderBy("timestamp")), (snapshot) => {
                ui.chatMessages.innerHTML = '';
                snapshot.forEach(doc => renderMessage(doc.data()));
                ui.chatMessages.scrollTop = ui.chatMessages.scrollHeight;
            });
        };

        // --- 8. UI RENDER FUNCTIONS ---
        const updateNowPlayingUI = (data, memories = []) => {
            currentNowPlaying = data;
            if (data && data.trackName) {
                ui.albumArt.src = data.albumArtUrl;
                ui.trackName.textContent = data.trackName;
                ui.artistName.textContent = data.artistName;
                const isMemory = memories.some(m => m.trackUri === data.trackUri);
                ui.memoryBtn.classList.toggle('loved', isMemory);
                ui.memoryBtn.title = isMemory ? "This is one of our songs!" : "Make this one of our songs";
            }
        };
        
        const updateQueueUI = (queue = []) => {
             if (queue.length === 0) {
                ui.queueList.innerHTML = `<p class="text-center text-rose-400 p-4">The queue is empty. Add a song!</p>`;
                return;
            }
            ui.queueList.innerHTML = queue.map(track => `
                <div class="flex items-center p-2 rounded-lg hover:bg-rose-100 group">
                    <img src="${track.albumArtUrl}" class="w-10 h-10 rounded-md mr-4">
                    <div class="flex-grow">
                        <p class="font-bold text-rose-800">${track.trackName}</p>
                        <p class="text-sm text-rose-500">${track.artistName}</p>
                        <p class="text-xs text-rose-400 italic">Added by: ${track.addedBy}</p>
                    </div>
                    <button class="remove-queue-btn text-rose-400 hover:text-rose-600 opacity-0 group-hover:opacity-100" data-track='${JSON.stringify(track)}' title="Remove">‚ùå</button>
                </div>`).join('');
        };
        
        const updateMemoriesUI = (memories = []) => {
             if (memories.length === 0) {
                ui.memoriesList.innerHTML = `<p class="text-center text-rose-400 p-4">Click the heart on a playing song to save it here forever.</p>`;
                return;
            }
            ui.memoriesList.innerHTML = memories.slice().reverse().map(track => `
                <div class="flex items-center p-2 rounded-lg hover:bg-rose-100">
                    <img src="${track.albumArtUrl}" class="w-10 h-10 rounded-md mr-4">
                    <div>
                        <p class="font-bold text-rose-800">${track.trackName}</p>
                        <p class="text-sm text-rose-500">${track.artistName}</p>
                    </div>
                </div>`).join('');
        };

        const updatePartnerStatusUI = (users = []) => {
            const me = users.find(u => u.id === userId);
            const partner = users.find(u => u.id !== userId);
            const now = new Date();
            const isOnline = (user) => user && user.lastSeen && (now - user.lastSeen.toDate()) < 45000;
            const renderProfile = (user, online) => {
                if (!user) return `<div class="flex flex-col items-center"><div class="w-16 h-16 rounded-full bg-rose-200 border-2 border-dashed border-rose-300 flex items-center justify-center text-center p-1"><span class="text-xs text-rose-400">Waiting for partner...</span></div></div>`;
                return `
                    <div class="flex flex-col items-center text-center">
                        <img src="${user.imageUrl}" class="w-16 h-16 rounded-full border-4 ${online ? 'border-green-400' : 'border-rose-200'}">
                        <p class="font-bold text-rose-800 mt-1">${user.name}</p>
                    </div>`;
            };
            ui.partnerStatus.innerHTML = `${renderProfile(me, isOnline(me))}<span class="text-3xl text-rose-400">&</span>${renderProfile(partner, isOnline(partner))}`;
        };

        const showReaction = (emoji) => {
            const reactionEl = document.createElement('div');
            reactionEl.className = 'reaction-pop absolute';
            reactionEl.style.left = `${Math.random() * 80}%`;
            reactionEl.style.top = `${Math.random() * 80}%`;
            reactionEl.textContent = emoji;
            ui.reactionContainer.appendChild(reactionEl);
            setTimeout(() => reactionEl.remove(), 1000);
        };

        const renderMessage = (msg) => {
            const isMe = msg.userId === userId;
            const el = document.createElement('div');
            el.className = `flex flex-col w-full ${isMe ? 'items-end' : 'items-start'}`;
            let content = `<p class="p-2 rounded-lg max-w-xs break-words ${isMe ? 'bg-rose-500 text-white' : 'bg-rose-100'}">${msg.text}</p>`;
            if (msg.isDedication) {
                content = `<div class="text-center p-2 my-2 text-sm text-rose-600 w-full">üíï ${msg.text} üíï</div>`
            }
            el.innerHTML = msg.isDedication ? content : `<p class="text-xs text-rose-400 px-2">${isMe ? 'You' : msg.userName}</p>${content}`;
            ui.chatMessages.appendChild(el);
        };

        // --- 9. EVENT LISTENERS ---
        ui.searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = ui.searchInput.value;
            if (!query) return;
            ui.searchButton.innerHTML = `<div class="spinner w-5 h-5 mx-auto"></div>`;
            try {
                const results = await spotifyApi(`/search?q=${encodeURIComponent(query)}&type=track&limit=5`);
                if (!results || !results.tracks) {
                    ui.searchResults.innerHTML = `<p class="text-center text-red-500">No results found.</p>`;
                    return;
                }
                ui.searchResults.innerHTML = results.tracks.items.map(track => {
                    const trackData = {
                        trackUri: track.uri,
                        trackName: track.name,
                        artistName: track.artists.map(a => a.name).join(', '),
                        albumArtUrl: track.album.images[2]?.url || track.album.images[0].url,
                        addedBy: userProfile.display_name
                    };
                    return `
                    <div class="p-2 rounded-lg hover:bg-rose-100">
                        <div class="flex items-center">
                            <img src="${trackData.albumArtUrl}" class="w-10 h-10 rounded-md mr-4">
                            <div class="flex-grow">
                                <p class="font-bold text-rose-800">${track.name}</p>
                                <p class="text-sm text-rose-500">${track.artists.map(a => a.name).join(', ')}</p>
                            </div>
                        </div>
                        <div class="flex items-center mt-2">
                             <input type="text" class="dedication-input flex-grow p-1 text-sm border border-rose-200 rounded-l-lg" placeholder="Dedicate this song... (optional)">
                             <button class="add-queue-btn bg-rose-400 text-white text-sm p-1 rounded-r-lg" data-track='${JSON.stringify(trackData)}'>Add</button>
                        </div>
                    </div>`;
                }).join('');
            } catch (error) { console.error("Search failed:", error); }
            finally { ui.searchButton.textContent = "Search"; }
        });
        
        document.body.addEventListener('click', async (e) => {
            const addBtn = e.target.closest('.add-queue-btn');
            if (addBtn) {
                const trackData = JSON.parse(addBtn.dataset.track);
                await updateDoc(getSessionDocRef(), { queue: arrayUnion(trackData) });
                
                const dedicationInput = addBtn.previousElementSibling;
                const dedicationText = dedicationInput.value.trim();
                if(dedicationText) {
                     await addDoc(getChatCollectionRef(), { 
                        text: `${userProfile.display_name} dedicates "${trackData.trackName}": ${dedicationText}`, 
                        userName: "Love Notes", 
                        timestamp: serverTimestamp(),
                        isDedication: true
                    });
                }
                ui.searchResults.innerHTML = ''; ui.searchInput.value = '';
            }

            const removeBtn = e.target.closest('.remove-queue-btn');
            if (removeBtn) {
                const trackData = JSON.parse(removeBtn.dataset.track);
                await updateDoc(getSessionDocRef(), { queue: arrayRemove(trackData) });
            }
        });

        ui.memoryBtn.addEventListener('click', async () => {
            if (!currentNowPlaying || !currentNowPlaying.trackUri) return;
            const docSnap = await getDoc(getSessionDocRef());
            const memories = docSnap.data().memories || [];
            const isMemory = memories.some(m => m.trackUri === currentNowPlaying.trackUri);

            if (isMemory) {
                const memoryToRemove = memories.find(m => m.trackUri === currentNowPlaying.trackUri);
                if(memoryToRemove) await updateDoc(getSessionDocRef(), { memories: arrayRemove(memoryToRemove) });
            } else {
                await updateDoc(getSessionDocRef(), { memories: arrayUnion(currentNowPlaying) });
            }
        });
        
        ui.chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = ui.chatInput.value.trim();
            if (text) {
                await addDoc(getChatCollectionRef(), { text, userId, userName: userProfile.display_name, timestamp: serverTimestamp() });
                ui.chatInput.value = '';
            }
        });

        document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', (e) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active', 'text-rose-600', 'border-rose-500'));
            e.currentTarget.classList.add('active', 'text-rose-600', 'border-rose-500');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(`${e.currentTarget.dataset.tab}-tab`).classList.remove('hidden');
        }));

        document.querySelectorAll('.reaction-btn').forEach(btn => btn.addEventListener('click', (e) => {
            updateDoc(getSessionDocRef(), { lastReaction: { emoji: e.currentTarget.dataset.emoji, ts: serverTimestamp() } });
        }));

    </script>
</body>
</html>